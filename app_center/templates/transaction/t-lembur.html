{% extends "layouts/base.html" %}

{% block title %} Lembur {% endblock %}

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<div class="container-xxl flex-grow-1 container-p-y">
  <div class="card">
    <div class="card-datatable table-responsive pt-0">
      <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper dt-bootstrap5 no-footer">
        <div class="card-header flex-column flex-md-row border-bottom">
          <div class="head-label text-center">
            <h5 class="card-title mb-0">Lembur</h5>
          </div>
          <div class="dt-action-buttons text-end pt-3 pt-md-0">
            <div class="dt-buttons btn-group flex-wrap">
              <button type="button" class="btn btn-primary waves-effect waves-light" data-bs-toggle="modal"
                data-bs-target="#modal-add">
                <i class="ri-add-line ri-16px me-sm-2"></i> Add Lembur
              </button>
            </div>
          </div>
        </div>
        <div class="card-datatable table-responsive">
          <table class="table w-100" id="datatable">
            <thead>
              <tr>
                <th>ID</th>
                <th>NIK</th>
                <th>Nama</th>
                <th>Start Lembur</th>
                <th>End Lembur</th>
                <th>Lokasi</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL ADD -->
<div class="modal animate__animated animate__zoomIn" id="modal-add" tabindex="-1" style="display: none;"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="exampleModalLabel5">Add Lembur</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="add-form">
        <div class="modal-body">
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="nik" class="form-control" placeholder="Enter NIK" required>
                <label for="nik">NIK</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="nama" class="form-control" placeholder="Enter Nama" readonly="True" required>
                <label for="nama">Nama</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="lokasi" class="form-control" placeholder="Enter Lokasi" readonly="True" required>
                <label for="lokasi">Lokasi</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-4 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="datetime-local" id="start_lembur" class="form-control" placeholder="start_lembur" required>
                <label for="start_lembur">Start Lembur</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-4 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="datetime-local" id="end_lembur" class="form-control" placeholder="end_lembur" required>
                <label for="end_lembur">End Lembur</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary waves-effect" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary waves-effect waves-light">Save changes</button>
        </div>
      </form>
      <script>
      function clearNikResult() {
        $('#nama').val('');
        $('#lokasi').val('');
      }

      function fetchEmployeeByNik(nik) {
        if (!nik) {
          clearNikResult();
          return;
        }
        $.ajax({
          url: '/api/m-employees',
          type: 'POST',
          dataType: 'json',
          data: {
            mode: 'dropdown',
            nik: nik
          },
          success: function (response) {
            if (response && response.status === 'success' && response.data && response.data.length > 0) {
              var emp = response.data[0];
              console.log(emp)
              $('#nama').val(emp.nama);
              $('#lokasi').val(emp.departemen);
            } else {
              clearNikResult();
            }
          },
          error: function () {
            clearNikResult();
          }
        });
      }
      </script>
    </div>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="modal animate__animated animate__zoomIn" id="modal-detail" tabindex="-1" style="display: none;"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="exampleModalLabel5">Detail Lembur</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="detail-form">
        <div class="modal-body">
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="detail_nik" class="form-control" placeholder="Enter NIK" readonly required>
                <label for="detail_nik">NIK</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="detail_nama" class="form-control" placeholder="Enter Nama" readonly required>
                <label for="detail_nama">Nama</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="detail_lokasi" class="form-control" placeholder="Enter Lokasi" readonly required>
                <label for="detail_lokasi">Lokasi</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="detail_start_lembur" class="form-control" placeholder="Enter Start Lembur" readonly required>
                <label for="detail_start_lembur">Start Lembur</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="detail_end_lembur" class="form-control" placeholder="Enter End Lembur" readonly required>
                <label for="detail_end_lembur">End Lembur</label>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary waves-effect" data-bs-dismiss="modal">Close</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL EDIT -->
<div class="modal animate__animated animate__zoomIn" id="modal-edit" tabindex="-1" style="display: none;"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="exampleModalLabel5">Edit Lembur</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="edit-form">
        <input type="hidden" id="edit_id">
        <div class="modal-body">
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="edit_nik" class="form-control" placeholder="Enter NIK" required>
                <label for="edit_nik">NIK</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="edit_nama" class="form-control" placeholder="Enter Nama" required>
                <label for="edit_nama">Nama</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="edit_lokasi" class="form-control" placeholder="Enter Lokasi" required>
                <label for="edit_lokasi">Lokasi</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="datetime-local" id="edit_start_lembur" class="form-control" placeholder="Enter Start Lembur" required>
                <label for="edit_start_lembur">Start Lembur</label>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="datetime-local" id="edit_end_lembur" class="form-control" placeholder="Enter End Lembur" required>
                <label for="edit_end_lembur">End Lembur</label>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary waves-effect" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary waves-effect waves-light">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal fade" id="modal-delete" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content text-center">
      <div class="modal-header flex-column">
        <div class="icon-box">
          <i class="ri-delete-bin-5-line text-danger ri-5x "></i>
        </div>
        <h4 class="modal-title w-100">Are you sure?</h4>
      </div>
      <form id="delete-form">
        <div class="modal-body">
          <input type="hidden" name="" id="id-delete">
          <p>Do you really want to delete these records? This process cannot be undone.</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script type="text/javascript">
  $(document).ready(function () {
    var nikLookupTimer = null;

    var table = $('#datatable').DataTable({
      processing: true,
      serverSide: true,
      order: [[0, 'desc']],
      serverMethod: 'POST',
      ajax: {
        url: "/api/t-lembur",
        data: function (sc) {
          sc.mode = 'datatable'
          return sc
        }
      },
      dataType: 'JSON',
      lengthMenu: [[10, 30, 50, 100], [10, 30, 50, 100]],
      paging: true,
      paginate: {
        next: '<i class="ri-arrow-right-s-line"></i>',
        previous: '<i class="ri-arrow-left-s-line"></i>'
      },
      searching: true,
      columns: [
        { data: 'id', },
        { data: 'nik' },
        { data: 'nama' },
        { data: 'start_lembur' },
        { data: 'end_lembur' },
        { data: 'lokasi' },
        {
          orderable: false,
          className: 'control',
          data: null,
          render: function (data) {
            return `
              <div class="d-flex align-items-center">
                <a href="javascript:;" class="me-2 detail-record" data-bs-toggle="tooltip" title="Detail"><i class="ri-eye-line text-secondary" ></i> </a>
                <a href="javascript:;" class="me-2 edit-record" data-bs-toggle="tooltip" title="Edit"><i class="ri-edit-box-line text-primary"></i> </a> 
                <a href="javascript:;" class="me-2 delete-record" data-bs-toggle="tooltip" title="Delete"><i class="ri-delete-bin-5-line text-danger"></i> </a>
              </div>
            `
          }
        },
      ]
    }); table.on('draw', function () { initializeTooltips(); });



    $(document).on('input', '#nik', function () {
      var nik = $(this).val().trim();
      if (nikLookupTimer) {
        clearTimeout(nikLookupTimer);
      }
      nikLookupTimer = setTimeout(function () {
        fetchEmployeeByNik(nik);
      }, 400);
    });

    $(document).on("submit", "#add-form", function(event){
      event.preventDefault();
      start_lembur = $('#start_lembur').val().replace('T', ' ')
      end_lembur = $('#end_lembur').val().replace('T', ' ')

      const formData = {
        nik: $('#nik').val(),
        nama: $('#nama').val(),
        lokasi: $('#lokasi').val(),
        start_lembur: start_lembur,
        end_lembur: end_lembur,
      };

      $.ajax({
        url: '/api/t-lembur', 
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
          $('#add-form')[0].reset();
          $('#modal-add').modal('hide')
          table.draw('page')
          alertModal[response.status](response.message)
        },
        error: function(xhr, status, error) {
          alert('Unauthorized. Please log in.')
          location.reload();
        }
      });
    })

    $(document).on("click", ".detail-record", function(event){
      event.preventDefault()
      rdata = table.row($(this).closest('tr')).data()
      $('#detail_nik').val(rdata.nik)
      $('#detail_nama').val(rdata.nama)
      $('#detail_lokasi').val(rdata.lokasi)
      $('#detail_start_lembur').val(rdata.start_lembur)
      $('#detail_end_lembur').val(rdata.end_lembur)

      $('#modal-detail').modal('show')
    })

    $(document).on("click", ".edit-record", async function(event){
      event.preventDefault();

      const rdata = table.row($(this).closest('tr')).data();

      $('#edit_id').val(rdata.id);
      $('#edit_nik').val(rdata.nik);
      $('#edit_nama').val(rdata.nama);
      $('#edit_lokasi').val(rdata.lokasi);
      $('#edit_start_lembur').val(rdata.start_lembur);
      $('#edit_end_lembur').val(rdata.end_lembur);

      $('#modal-edit').modal('show');
    });

    $(document).on("submit", "#edit-form", function(event){
      event.preventDefault();   
      start_lembur = $('#edit_start_lembur').val().replace('T', ' ')
      end_lembur = $('#edit_end_lembur').val().replace('T', ' ')

      const formData = {
        id: $('#edit_id').val(),
        nik: $('#edit_nik').val(),
        nama: $('#edit_nama').val(),
        lokasi: $('#edit_lokasi').val(),
        start_lembur: start_lembur,
        end_lembur: end_lembur,
      };

      $.ajax({
        url: '/api/t-lembur', 
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
          $('#response-message').html('<p>' + response.message + '</p>');
          $('#modal-edit').modal('hide') 
          table.draw('page')
          alertModal[response.status](response.message)
        },
        error: function(xhr, status, error) {
          alert('Unauthorized. Please log in.')
          location.reload();
        }
      });
      $('#modal-edit').modal('show')      
    })

    $(document).on("click", ".delete-record", function(event){
      event.preventDefault()
      rdata = table.row($(this).closest('tr')).data()
      $('#id-delete').val(rdata.id)
      $('#modal-delete').modal('show')
    })

    $(document).on("submit", "#delete-form", function(event){
      event.preventDefault()
      const formData = {
        id: $('#id-delete').val(),
      };
      $.ajax({
        url: '/api/t-lembur', 
        type: 'DELETE',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
          $('#response-message').html('<p>' + response.message + '</p>');
          $('#modal-delete').modal('hide') 
          table.draw('page')
          alertModal[response.status](response.message)
        },
        error: function(xhr, status, error) {
          alert('Unauthorized. Please log in.')
          location.reload();
        }
      });
    })


  });


</script>

{% endblock content %}

{% block javascripts %}{% endblock javascripts %}
