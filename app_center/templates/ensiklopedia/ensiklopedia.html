{% extends "layouts/base.html" %}

{% block title %} Ensiklopedia {% endblock %}

{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<div class="container-xxl flex-grow-1 container-p-y">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Ensiklopedia</h5>
  </div>

  <div class="mb-4 d-flex gap-2">
    <input type="text" id="searchInput" class="form-control" placeholder="Cari berdasarkan judul atau nama file...">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modal-add">
      <i class="ri-upload-line ri-16px me-sm-1"></i> Upload
    </button>
  </div>

  <div class="row g-4" id="file-card-container">
  </div>
</div>


<!-- MODAL ADD -->
<div class="modal animate__animated animate__zoomIn" id="modal-add" tabindex="-1" style="display: none;"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="exampleModalLabel5">Upload File</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="add-form" enctype="multipart/form-data">
        <div class="modal-body">
          <div class="mb-3">
            <label for="fileUpload" class="form-label">Pilih File</label>
            <input class="form-control" type="file" id="fileUpload" name="file"
              accept="image/jpg, image/jpeg, image/png, application/pdf" required>
          </div>
          <div class="mb-3">
            <label for="judul" class="form-label">Judul</label>
            <input type="text" class="form-control" id="judul" name="judul" placeholder="Masukkan judul" required>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary waves-effect" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary waves-effect waves-light">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL DETAIL -->
<div class="modal animate__animated animate__zoomIn" id="modal-preview" tabindex="-1" style="display: none;"
  aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header mb-2">
        <h4 class="modal-title" id="exampleModalLabel5">Preview File</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="d-flex justify-content-end mb-2 gap-2 px-5" id="preview-controls">
        <!-- <button class="btn btn-outline-secondary btn-sm" id="zoom-out"><i class="ri-subtract-line"></i></button>
        <button class="btn btn-outline-secondary btn-sm" id="zoom-in"><i class="ri-add-line"></i></button> -->
        <a href="#" class="btn btn-outline-primary btn-sm" id="download-pdf" target="_blank" download><i
            class="ri-download-2-line"></i></a>
      </div>

      <div class="modal-body text-center" id="modal-body-preview" style="height: 70vh">
        <!-- Konten akan diisi lewat JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDIT -->
<div class="modal animate__animated animate__zoomIn" id="modal-edit" tabindex="-1" style="display: none;"
  aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title" id="exampleModalLabel5">Edit Role</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="edit-form">
        <input type="hidden" id="edit_id">
        <div class="modal-body">
          <div class="row">
            <div class="col mb-6 mt-2">
              <div class="form-floating form-floating-outline">
                <input type="text" id="edit_role" class="form-control" placeholder="Enter Role" required>
                <label for="edit_role">Role</label>
              </div>
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary waves-effect" data-bs-dismiss="modal">Close</button>
          <button type="submit" class="btn btn-primary waves-effect waves-light">Save changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- MODAL DELETE -->
<div class="modal fade" id="modal-delete" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content text-center">
      <div class="modal-header flex-column">
        <div class="icon-box">
          <i class="ri-delete-bin-5-line text-danger ri-5x "></i>
        </div>
        <h4 class="modal-title w-100">Are you sure?</h4>
      </div>
      <form id="delete-form">
        <div class="modal-body">
          <input type="hidden" name="" id="id-delete">
          <p>Do you really want to delete these records? This process cannot be undone.</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>


<script type="text/javascript">

  let fileDataCache = [];

  const fileData = [
  ];

  function htmlCard(data = fileDataCache) {
    const $container = $('#file-card-container');
    $container.empty();

    data.forEach(file => {
      const nama_file_asli = file.file_name.split('-')[1];
      const ext = file.file_name.split('.').pop().toLowerCase();
      let iconClass = 'ri-file-line', iconColor = 'text-secondary';

      if (ext === 'pdf') {
        iconClass = 'ri-file-pdf-2-line';
        iconColor = 'text-danger';
      } else if (['png', 'jpg', 'jpeg'].includes(ext)) {
        iconClass = 'ri-file-image-line';
        iconColor = 'text-primary';
      }

        const $card = $(`
          <div class="col-lg-4 col-md-6">
            <div class="card shadow-sm h-100 border-0  detail-record" role="button">
              <div class="card-body d-flex flex-column justify-content-between">
                <div class="mb-3">
                  <div class="d-flex align-items-center mb-2">
                    <i class="${iconClass} ${iconColor} fs-2 me-2"></i>
                    <div class="text-truncate">
                      <h5 class="fw-bold text-dark mb-0 text-truncate" style="max-width: 250px;">${file.judul}</h5>
                      <small class="text-muted d-block text-truncate" style="max-width: 250px;">${nama_file_asli}</small>
                    </div>
                  </div>
                  <div class="mb-2 d-flex flex-wrap gap-1">
                    <span class="badge bg-light text-dark text-truncate">
                      <i class="ri-user-line me-1"></i>${file.pembuat}
                    </span>
                    <span class="badge bg-light text-dark">
                      <i class="ri-calendar-line me-1"></i>${file.tanggal_pembuatan}
                    </span>
                  </div>
                  <div class="d-flex flex-wrap gap-3 small border-top pt-2">
                    <div class="d-flex align-items-center me-3">
                      <i class="ri-file-line me-1 text-secondary"></i>
                      <strong class="me-1">Ekstensi:</strong>${file.ekstension}
                    </div>
                    <div class="d-flex align-items-center me-3">
                      <i class="ri-file-upload-line me-1 text-secondary"></i>
                      <strong class="me-1">Ukuran:</strong>${file.ukuran_file}
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                  <button class="btn btn-sm btn-outline-danger delete-record">
                    <i class="ri-delete-bin-line me-1"></i>Hapus
                  </button>
                </div>
              </div>
            </div>
          </div>
        `);

      // Tambahkan data ke seluruh card dan tombol hapus
      $card.find('.card').data('file', file);
      $card.find('.delete-record').data('file', file);

      $container.append($card);
    });
  }

  function formatFileSize(bytes) {
    const units = ['bytes', 'KB', 'MB', 'GB', 'TB'];
    let i = 0;

    while (bytes >= 1024 && i < units.length - 1) {
      bytes /= 1024;
      i++;
    }

    return bytes.toFixed(1) + ' ' + units[i];
  }

  function renderCard() {
    $.ajax({
      url: '/api/ensiklopedia',
      type: 'GET',
      success: function (response) {
        fileDataCache = response.data || [];
        htmlCard();
      },
      error: function () {
        console.error("Gagal mengambil data file.");
      }
    });
  }

  function showPreviewModal(fileUrl, fileName, ext) {
    // Set link download
    $('#download-pdf')
      .attr('href', fileUrl)
      .attr('download', fileName);

    // Show loader
    $('#modal-body-preview').html(`
      <div class="text-center py-5">
        <div class="spinner-border" role="status"></div>
        <p class="mt-2">Memuat pratinjau...</p>
      </div>
    `);
    $('#modal-preview').modal('show');

    setTimeout(function () {
        let htmlPreview = '';
        if (ext === 'pdf') {
          htmlPreview = `<iframe src="${fileUrl}#toolbar=0&navpanes=0&scrollbar=0" width="100%" height="100%" style="border: none;"></iframe>`;
        } else if (['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) {
          htmlPreview = `<img src="${fileUrl}" alt="Preview" style="max-width: 100%; max-height: 100%;">`;
        } else {
          htmlPreview = `<p class="text-danger">Preview tidak tersedia untuk file: ${fileName}</p>;`;
        }
        $('#modal-body-preview').html(htmlPreview);
      }, 1000); 
  }


  $(document).ready(function () {

    renderCard()

    $(document).on("change", "#fileUpload", function () {
      const file = this.files[0];
      if (file) {
        let fileName = file.name;
        $('#judul').val(fileName.replace(/\.[^.]+$/, ''));
      }
    })

    $(document).on("submit", "#add-form", function (event) {
      event.preventDefault();

      const formData = new FormData(this);
      const judul = formData.get("judul");
      const file = formData.get("file");

      if (!file) {
        console.warn("Tidak ada file yang dipilih.");
        return;
      }

      const fileName = file.name;
      const ekstensi = fileName.split('.').pop().toLowerCase();
      const ukuran = formatFileSize(file.size);

      sendDataJson = {
        "judul": judul,
        "file_name": fileName,
        "ekstension": ekstensi,
        "ukuran_file": ukuran,
      }
      data_input = new FormData();
      data_input.append("json", JSON.stringify(sendDataJson));
      data_input.append("file_ensiklopedia", file);

      $.ajax({
        url: '/api/ensiklopedia',
        type: 'POST',
        processData: false,
        contentType: false,
        data: data_input,
        success: function (response) {
          if (response.status === 'success') {
            $('#modal-add').modal('hide');
            Swal.fire({
              icon: 'success',
              title: 'Berhasil',
              text: 'File berhasil diunggah!',
              timer: 2000,
              showConfirmButton: false
            });

            renderCard();
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Gagal',
              text: 'Gagal menggunggah file',
            });
          }
        },
        error: function (xhr, status, error) {
          console.error("Error:", error);
          Swal.fire({
            icon: 'error',
            title: 'Kesalahan',
            text: 'Terjadi kesalahan saat mengunggah file.',
          });
        }
      });

    });

    $(document).on("input", "#searchInput", function () {
      const keyword = $(this).val().toLowerCase();

      const filtered = fileDataCache.filter(file => {
        const judul = file.judul?.toLowerCase() || '';
        const nama_file = file.file_name?.toLowerCase() || '';
        const nama_uploader = file.pembuat?.toLowerCase() || '';
        return judul.includes(keyword) || nama_file.includes(keyword);
      });

      htmlCard(filtered);
    });

    $(document).on('click', '.detail-record', function (event) {
      if ($(event.target).closest('.delete-record').length) return;

      event.preventDefault();

      const fileData = $(this).data('file');
      if (!fileData || !fileData.file_name) return;

      const fileName = fileData.file_name;
      const fileUrl = `/static/files/ensiklopedia/${fileName}`;
      const ext = fileName.split('.').pop().toLowerCase();

      showPreviewModal(fileUrl, fileName, ext);
    });

    $(document).on("click", ".delete-record", function (event) {
      event.preventDefault();
      event.stopPropagation();

      rdata = $(this).data('file');
      $('#id-delete').val(rdata.id)
      $('#modal-delete').modal('show');
    });

    $(document).on("submit", "#delete-form", function (event) {
      event.preventDefault()

      const id_form = $('#id-delete').val()
      $.ajax({
        url: '/api/ensiklopedia',
        type: 'DELETE',
        data: { id_form: id_form },
        success: function (response) {
          $('#response-message').html('<p>' + response.message + '</p>');
          $('#modal-delete').modal('hide')
          renderCard();
          alertModal[response.status](response.message)
        },
        error: function (xhr, status, error) {
          alert('Unauthorized. Please log in.')
          location.reload();
        }
      });
    })

  });

</script>

<style>
  .hover-expand {
    transition: transform 0.2s ease;
  }

  .hover-expand:hover {
    transform: scale(1.03);
    cursor: pointer;
  }
</style>


{% endblock content %}

{% block javascripts %}{% endblock javascripts %}